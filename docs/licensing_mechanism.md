# インストール台数制限（ライセンス認証）の実現方法

一般的なデスクトップアプリケーションにおけるインストール台数制限（アクティベーション回数制限）は、主に**「端末固有ID」と「認証サーバー」**の組み合わせによって実現されています。

## 1. 基本的な仕組み

アプリケーション単体で台数を数えることはできないため、クラウド上のデータベースで「どのライセンスキーが、どの端末（ID）で使用されているか」を管理します。

### 主要な構成要素

1.  **ライセンスキー (License Key)**: 購入時にユーザーに発行される一意の文字列。
2.  **端末固有ID (Device Fingerprint)**: PCのハードウェア情報（MACアドレス、HDDシリアル、マザーボード情報など）から生成される一意のID。
    *   *Electronでの実装例*: `node-machine-id` などのライブラリを使用。
3.  **認証サーバー (Licensing Server)**: ライセンスキーと端末IDの紐付けを管理・判定するサーバー。

## 2. 認証フロー

### 初回起動時（アクティベーション）

1.  **ID生成**: アプリが起動すると、ローカル端末のハードウェア情報から「端末固有ID（例: `HWID-12345`）」を生成します。
2.  **送信**: ユーザーが入力したライセンスキーと、生成した端末IDを認証サーバーへ送信します。
3.  **サーバー判定**:
    *   サーバーは、そのライセンスキーに紐付いている端末IDリストを確認します。
    *   **リストに含まれている場合**: そのまま認証OK。
    *   **リストに含まれていない場合**:
        *   現在の登録数が「上限（例: 2台）」未満であれば、リストにIDを追加して認証OK。
        *   上限に達している場合、エラー（「台数制限を超えています」）を返却。
4.  **ローカル保存**: 認証に成功したら、アプリはローカル（設定ファイルやセキュアストレージ）に「認証済み」状態や「アクセストークン」を保存します。

### 2回目以降（バリデーション）

*   **オンライン時**: 定期的（起動時や数日に1回）にサーバーへ端末IDを送り、ライセンスがまだ有効か（無効化されていないか、リモートで解除されていないか）を確認します。
*   **オフライン時**: 一定期間（例: 30日間）はローカルのキャッシュ情報で起動を許可するなどの猶予（Grace Period）を設けるのが一般的です。

## 3. 解除（ディアクティベーション）

ユーザーがPCを買い替える場合などのために、アプリ内に「認証解除」ボタンを用意します。
これを押すと、サーバー上のリストから該当の端末IDが削除され、空きスロット（ライセンス枠）が1つ復活します。

## 4. Volumix（Electron + 販売プラットフォーム）での実装アプローチ

自前で認証サーバーを構築するのはコストがかかるため、**Lemon Squeezy** や **Gumroad** が提供するライセンスAPIを利用するのが最も効率的です。

### Lemon Squeezy / Gumroad の場合
これらのプラットフォームは標準で「ライセンス管理機能」を持っています。

*   **設定**: 販売ページの設定で「Generate License Keys」をオンにし、「Limit to N activations」を設定するだけです。
*   **アプリ側の実装**: 起動時にAPI（`/v1/licenses/activate` 等）を叩くだけで、上記の「IDチェック・台数カウント・可否判定」をすべて代行してくれます。

### 開発者が実装すべきこと
1.  **`node-machine-id`** 等で端末IDを取得する処理。
2.  **APIリクエスト**: ライセンスキーと端末IDをLemon Squeezy/GumroadのAPIに投げる処理。
3.  **結果のハンドリング**: APIからのレスポンス（成功/失敗）に応じて、アプリ機能のロックを解除するか、エラー画面を出すかの分岐。
